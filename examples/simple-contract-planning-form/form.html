<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Demo Form</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="form">
      <h2>Demo Form</h2>
      <p>
        Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod
        tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim
        veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea
        commodo consequat. Duis aute irure dolor in reprehenderit in voluptate
        velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint
        occaecat cupidatat non proident, sunt in culpa qui officia deserunt
        mollit anim id est laborum.
      </p>

      <form id="form">
        <fieldset class="form_section">
          <legend class="form_section_title">Entry data</legend>

          <div class="form_row">
            <div class="form_field">
              <label for="consumption">Annual consumption</label>
              <input type="text" name="consumption" />
            </div>

            <div class="form_field">
              <label for="rooftops">Rooftop type</label>
              <select name="rooftops">
                <option value="pointy">Pointy</option>
                <option value="rounded">Rounded</option>
                <option value="big">Big</option>
                <option value="small">Small</option>
              </select>
            </div>

            <div class="form_field">
              <label for="solar_panels">Solar panels</label>
              <select name="solar_panels">
                <option value="mono">Mono</option>
                <option value="poly">Poly</option>
                <option value="thin">Thin</option>
              </select>
            </div>
          </div>
        </fieldset>

        <fieldset class="form_section">
          <legend class="form_section_title">Important data</legend>

          <div class="form_row">
            <div class="form_field">
              <label for="panels_count">Number of panels</label>
              <input type="text" name="panels_count" />
            </div>

            <div class="form_field">
              <label for="performance">Performance</label>
              <input type="text" name="performance" />
            </div>

            <div class="form_field">
              <label for="area">Area</label>
              <input type="text" name="area" />
            </div>
          </div>
        </fieldset>

        <fieldset class="form_section">
          <legend class="form_section_title">Individual items</legend>

          <div class="form_row">
            <div class="form_field">
              <label for="item1">Item 1</label>
              <input type="text" name="item1" />
            </div>

            <div class="form_field">
              <label for="item1_count">Count</label>
              <select name="item1_count">
                <option value="1">1 piece</option>
                <option value="2">2 pieces</option>
                <option value="3">3 pieces</option>
              </select>
            </div>

            <div class="form_field">
              <label for="item1_price">Price of one item</label>
              <input type="text" name="item1_price" />
            </div>

            <div class="form_field">
              <label for="item1_price_total">Total Price</label>
              <input type="text" name="item1_price_total" />
            </div>
          </div>

          <div class="form_row">
            <div class="form_field">
              <label for="item2">Item 2</label>
              <input type="text" name="item2" />
            </div>

            <div class="form_field">
              <label for="item2_count">Count</label>
              <select name="item2_count">
                <option value="1">1 piece</option>
                <option value="2">2 pieces</option>
                <option value="3">3 pieces</option>
              </select>
            </div>

            <div class="form_field">
              <label for="item2_price">Price of one item</label>
              <input type="text" name="item2_price" />
            </div>

            <div class="form_field">
              <label for="item2_price_total">Total Price</label>
              <input type="text" name="item2_price_total" />
            </div>
          </div>

          <div class="form_row">
            <div class="form_field">
              <label for="item3">Item 3</label>
              <input type="text" name="item3" />
            </div>

            <div class="form_field">
              <label for="item3_count">Count</label>
              <select name="item3_count">
                <option value="1">1 piece</option>
                <option value="2">2 pieces</option>
                <option value="3">3 pieces</option>
              </select>
            </div>

            <div class="form_field">
              <label for="item3_price">Price of one item</label>
              <input type="text" name="item3_price" />
            </div>

            <div class="form_field">
              <label for="item3_price_total">Total Price</label>
              <input type="text" name="item3_price_total" />
            </div>
          </div>
        </fieldset>

        <fieldset class="form_section">
          <legend class="form_section_title">Contact information</legend>

          <div class="form_row">
            <div class="form_field">
              <label for="first_name">First name</label>
              <input type="text" name="first_name" />
            </div>

            <div class="form_field">
              <label for="last_name">Last name</label>
              <input type="text" name="last_name" />
            </div>
          </div>

          <div class="form_row">
            <div class="form_field">
              <label for="email">Email</label>
              <input type="text" name="email" />
            </div>

            <div class="form_field">
              <label for="phone">Phone</label>
              <input type="text" name="phone" minlength="9" />
            </div>
          </div>
        </fieldset>
        <input type="submit" value="Submit" class="submit-button" id="submit" />
      </form>
    </div>

    <script type="module">
      // Import ElixeumClient, or use global ElixeumClient variable when you are loading library from CDN
      import ElixeumClient from "/src/index.js";

      // TODO: Create apptoken with required permissions in your tenant and use it here
      // Please keep in mind, the token is visible to the user, so it can be misused
      // Limit permissions to the minimum required
      let appToken = undefined;

      // Create JS client, token, api are required
      // Debug enables more debug logging
      let elixeum = new ElixeumClient({
        token: appToken,
        api: "https://develop.portal.elixeum.cloud",
        debug: true,
      });

      // Get Contract Planning module
      let contractPlanning = elixeum.ContractPlanning();

      // Create contract draft
      let contractDraft = contractPlanning.ContractModel();

      // Helper function to format phone number
      const formatPhoneNumber = (number) => {
        if (number == null) {
          return "";
        }

        // Strip white characters and spaces
        number = number.replace(/\s/g, "");

        if (number.length == 9) {
          return "+420" + number;
        }

        if (number.startsWith("+")) {
          return number;
        } else {
          return "+" + number;
        }
      };

      let form = document.querySelector("#form");

      form.addEventListener("submit", (e) => {
        e.preventDefault();
        let data = new FormData(form);
        let formData = {
          consumption: data.get("consumption") ?? "",
          rooftop_type: data.get("rooftops") ?? "",
          solar_panels: data.get("solar_panels") ?? "",
          panels_count: data.get("panels_count") ?? "",
          performance: data.get("performance") ?? "",
          area: data.get("area") ?? "",
          items: [
            {
              item: data.get("item1") ?? "",
              count: data.get("item1_count") ?? "",
              price: data.get("item1_price") ?? "",
              price_total: data.get("item1_price-total") ?? "",
            },
            {
              item: data.get("item2") ?? "",
              count: data.get("item2_count") ?? "",
              price: data.get("item2_price") ?? "",
              price_total: data.get("item2_price-total") ?? "",
            },
            {
              item: data.get("item3") ?? "",
              count: data.get("item3_count") ?? "",
              price: data.get("item3_price") ?? "",
              price_total: data.get("item3_price-total") ?? "",
            },
          ],
          contact_information: {
            roleType: 0,
            email: data.get("email") ?? "",
            person: {
              pin: data.get("email") ?? "",
              firstName: data.get("first_name") ?? "",
              lastName: data.get("last_name") ?? "",
              phone: formatPhoneNumber(data.get("phone") ?? ""),
            },
            phone: formatPhoneNumber(data.get("phone") ?? ""),
            displayName: data.get("first_name") + " " + data.get("last_name"),
            identifier: data.get("email") ?? "",
            addresses: [],
          },
        };

        // TODO: Modify your contract IDs
        let contractData = {
          contract: {
            typeNumber: 414,
            contractTypeId: "52b4807d-aaeb-4522-bd49-b8c3e8375a70",
          },
          customFields: [
            {
              customFieldId: "6e69b2ce-18ff-475e-95e6-a09a0bd84de6",
              value: formData.rooftop_type,
            },
            {
              customFieldId: "8cff81e9-160c-4ebc-bb2d-dd3f931314b8",
              value: formData.solar_panels,
            },
          ],
        };

        // Create draft request and send it (Send returns Promise)
        let contractRequest = contractPlanning.CreateContractDraftRequest(
          formData,
          contractData
        );

        contractRequest.send().then(
          (success) => {
            console.log(success);
            alert("Contract draft created");
            form.reset();
          },
          (error) => {
            console.log(error);
            alert("Error creating contract draft");
          }
        );
      });
    </script>
  </body>
</html>
